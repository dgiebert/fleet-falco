defaultNamespace: falco

namespaceLabels:
  pod-security.kubernetes.io/enforce: privileged
  pod-security.kubernetes.io/enforce-version: latest

labels:
  app: falco

# Custom helm options
helm:
  releaseName: falco
  chart: falco
  repo: https://falcosecurity.github.io/charts
  version: 4.1.1
  values:
    falcosidekick:
      enabled: true
      webui:
        enabled: true
        disableauth: true
        replicaCount: 1
        ingress:
          enabled: true
        redis:
          storageEnabled: false
    collectors:
      containerd:
        enabled: true
        socket: /var/run/k3s/containerd/containerd.sock
      kubernetes:
        enabled: false
      crio:
        enabled: false
      docker:
        enabled: false
    customRules:
      rules-api-access.yaml: |-
        # Add a custom additional application rule that is wrapped so we can use append easily
        - rule: Contact K8S API Server From Container
          condition: >
            and not (user_known_contact_k8s_api_server_applications)
          override:
            condition: append
        - macro: user_known_contact_k8s_api_server_activities
          condition: >
            (k8s.ns.name = "cattle-system" and (proc.exepath = "/usr/bin/agent" or (container.name = "proxy" and proc.name = "kubectl")))
      rules-kubevip.yaml: |-
        - list: user_known_packet_socket_binaries
          append: yes
          items: ["kube-vip"]
      rules-applications.yaml: |-
        - macro: user_known_contact_k8s_api_server_applications
          condition: >
              (k8s.ns.name = "local-path-storage" and container.name = "local-path-provisioner"))
              or (k8s.ns.name = "cattle-monitoring-system" and (container.name in ("grafana-sc-dashboard", "grafana-sc-datasources") or
                                                                k8s.pod.name startswith "rancher-monitoring-patch" or
                                                                k8s.pod.name startswith "rancher-monitoring-upgrade" or
                                                                k8s.pod.name startswith "rancher-monitoring-crd-create" or
                                                                k8s.pod.name startswith "rancher-monitoring-admission-patch")
        - macro: user_known_contact_k8s_api_server_applications
          condition: >
              or (k8s.ns.name = "kubewarden" and container.name in ("manager", "post-install-job", "audit-scanner", "policy-reporter"))
              or (container.image.repository startswith "ghcr.io/zalando/spilo" and (proc.cmdline startswith "patroni" or 
                                                                                     proc.cmdline startswith "postgres"))
          override:
            condition: append
    driver:
      kind: ebpf
    falco:
      grpc:
        enabled: true
      grpc_output:
        enabled: true
